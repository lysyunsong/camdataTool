<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.part.data.mapper.ComponentMapper">

<!--    <select id="extractComponentWithSubnode" resultType="com.part.data.entity.ComponentVO">-->
<!--        SELECT-->
<!--        &#45;&#45; 只查询必要字段，避免SELECT *带来的额外开销-->
<!--        parentStructId,-->
<!--        parentCkid,-->
<!--        parentName,-->
<!--        parentNameEn,-->
<!--        parentSymbol,-->
<!--        parentWeight,-->
<!--        subnodeType,-->
<!--        subnodeCkid,-->
<!--        subnodeName,-->
<!--        subnodeEnName,-->
<!--        subnodeSymbol,-->
<!--        subnodeWeight,-->
<!--        subnodeQuantity,-->
<!--        subnodeStructId-->
<!--        FROM (-->
<!--        SELECT-->
<!--        inner_query.*,-->
<!--        ROWNUM AS rn-->
<!--        FROM (-->
<!--        SELECT-->
<!--        pstr.CSID AS parentStructId,-->
<!--        pstr.CCKID AS parentCkid,-->
<!--        comp_parent.CNAME AS parentName,-->
<!--        comp_parent.CEN_NAME AS parentNameEn,-->
<!--        comp_parent.CSYMBOL AS parentSymbol,-->
<!--        comp_parent.CMEA_WEIGHT_PER_ITEM AS parentWeight,-->
<!--        CASE-->
<!--        WHEN cstr.CNODE_TYPE = 1 THEN '零部件'-->
<!--        WHEN cstr.CNODE_TYPE = 2 THEN '半成品'-->
<!--        WHEN cstr.CNODE_TYPE = 3 THEN '材料'-->
<!--        ELSE '其他'-->
<!--        END AS subnodeType,-->
<!--        &#45;&#45; 提前过滤NULL值，减少COALESCE计算开销-->
<!--        CASE WHEN cstr.CNODE_TYPE = 1 THEN comp_sub.CKID-->
<!--        WHEN cstr.CNODE_TYPE = 2 THEN semi_sub.CKID-->
<!--        WHEN cstr.CNODE_TYPE = 3 THEN mat_sub.CKID-->
<!--        END AS subnodeCkid,-->
<!--        CASE WHEN cstr.CNODE_TYPE = 1 THEN comp_sub.CNAME-->
<!--        WHEN cstr.CNODE_TYPE = 2 THEN semi_sub.CNAME-->
<!--        WHEN cstr.CNODE_TYPE = 3 THEN mat_sub.CNAME-->
<!--        END AS subnodeName,-->
<!--        CASE WHEN cstr.CNODE_TYPE = 1 THEN comp_sub.CEN_NAME-->
<!--        WHEN cstr.CNODE_TYPE = 2 THEN semi_sub.CEN_NAME-->
<!--        WHEN cstr.CNODE_TYPE = 3 THEN mat_sub.CEN_NAME-->
<!--        END AS subnodeEnName,-->
<!--        CASE WHEN cstr.CNODE_TYPE = 1 THEN comp_sub.CSYMBOL-->
<!--        WHEN cstr.CNODE_TYPE = 2 THEN semi_sub.CSYMBOL-->
<!--        WHEN cstr.CNODE_TYPE = 3 THEN mat_sub.CSYMBOL-->
<!--        END AS subnodeSymbol,-->
<!--        CASE WHEN cstr.CNODE_TYPE = 1 THEN comp_sub.CMEA_WEIGHT_PER_ITEM-->
<!--        ELSE cstr.CWEIGHT-->
<!--        END AS subnodeWeight,-->
<!--        cstr.CQUANTITY AS subnodeQuantity,-->
<!--        cstr.CSID AS subnodeStructId-->
<!--        FROM t_mds t-->
<!--        &#45;&#45; 调整表连接顺序：小表驱动大表，减少外层循环次数-->
<!--        JOIN t_structure_list pstr-->
<!--        ON pstr.CCKID = t.CKID-->
<!--        JOIN T_COMPONENT_NODE comp_parent-->
<!--        ON pstr.CCKID = comp_parent.CKID-->
<!--        AND comp_parent.CSTATUS != 'ED'-->
<!--        &#45;&#45; 提前过滤父节点名称，减少后续连接数据量-->
<!--        <if test="parentNameLike != null and parentNameLike != ''">-->
<!--            AND comp_parent.CNAME LIKE '%' || #{parentNameLike} || '%'-->
<!--        </if>-->
<!--        JOIN t_structure_list cstr-->
<!--        ON pstr.CSID = cstr.CPSID-->
<!--        &#45;&#45; 按CNODE_TYPE条件拆分左连接，避免无效数据关联-->
<!--        LEFT JOIN T_COMPONENT_NODE comp_sub-->
<!--        ON cstr.CCKID = comp_sub.CKID-->
<!--        AND cstr.CNODE_TYPE = 1-->
<!--        AND comp_sub.CDEL_FLAG = 0-->
<!--        AND comp_sub.CSTATUS != 'ED'-->
<!--        LEFT JOIN T_SEMI_COMPONENT_NODE semi_sub-->
<!--        ON cstr.CCKID = semi_sub.CKID-->
<!--        AND cstr.CNODE_TYPE = 2-->
<!--        AND semi_sub.CDEL_FLAG = 0-->
<!--        AND (semi_sub.CINNER = 0 OR semi_sub.CMODULE = 1)-->
<!--        LEFT JOIN t_material mat_sub-->
<!--        ON cstr.CCKID = mat_sub.CKID-->
<!--        AND cstr.CNODE_TYPE = 3-->
<!--        AND mat_sub.CDEL_FLAG = 0-->
<!--        WHERE t.CMDSTYPE = 1-->
<!--        &#45;&#45; 排序字段移至最内层，减少排序数据量-->
<!--&#45;&#45;         ORDER BY comp_parent.CNAME DESC-->
<!--        ) inner_query-->
<!--        &#45;&#45; 尽早应用分页，限制中间结果集大小-->
<!--        <if test="limit != null and limit > 0">-->
<!--            WHERE ROWNUM &lt;= #{limit}-->
<!--        </if>-->
<!--        )-->
<!--    </select>-->
    <select id="extractComponentWithSubnode" resultType="com.part.data.entity.ComponentVO">
        SELECT
        pstr.CSID AS parentStructId,
        pstr.CCKID AS parentCkid,
        comp_parent.CNAME AS parentName,
        comp_parent.CEN_NAME AS parentNameEn,
        comp_parent.CSYMBOL AS parentSymbol,
        comp_parent.CMEA_WEIGHT_PER_ITEM AS parentWeight,
        cstr.CNODE_TYPE  AS subnodeType,
        cstr.CCKID AS subnodeCkid,
        COALESCE(comp_sub.CNAME, semi_sub.CNAME, mat_sub.CNAME) AS subnodeName,
        COALESCE(comp_sub.CEN_NAME, semi_sub.CEN_NAME, mat_sub.CEN_NAME) AS subnodeEnName,
        COALESCE(comp_sub.CSYMBOL, semi_sub.CSYMBOL, mat_sub.CSYMBOL) AS subnodeSymbol,
        CASE WHEN cstr.CNODE_TYPE = 1 THEN comp_sub.CMEA_WEIGHT_PER_ITEM
        ELSE cstr.CWEIGHT
        END AS subnodeWeight,
        cstr.CQUANTITY AS subnodeQuantity,
        cstr.CSID AS subnodeStructId
        FROM t_mds t
        JOIN t_structure_list pstr ON pstr.CCKID = t.CKID
        JOIN T_COMPONENT_NODE comp_parent ON pstr.CCKID = comp_parent.CKID
        <if test="startDate != null and endDate != null">
            AND comp_parent.CCREATE_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD HH24:MI:SS')
            AND TO_DATE(#{endDate}, 'YYYY-MM-DD HH24:MI:SS')
        </if>
        <if test="parentNameLike != null and parentNameLike != ''">
            AND comp_parent.CNAME LIKE '%' || #{parentNameLike} || '%'
        </if>
        JOIN t_structure_list cstr ON pstr.CSID = cstr.CPSID
        LEFT JOIN T_COMPONENT_NODE comp_sub ON cstr.CCKID = comp_sub.CKID
        AND cstr.CNODE_TYPE = 1
        AND comp_sub.CDEL_FLAG = 0
        AND comp_sub.CSTATUS != 'ED'
        LEFT JOIN T_SEMI_COMPONENT_NODE semi_sub ON cstr.CCKID = semi_sub.CKID
        AND cstr.CNODE_TYPE = 2
        AND semi_sub.CDEL_FLAG = 0
        AND (semi_sub.CINNER = 0 OR semi_sub.CMODULE = 1)
        LEFT JOIN t_material mat_sub ON cstr.CCKID = mat_sub.CKID
        AND cstr.CNODE_TYPE = 3
        AND mat_sub.CDEL_FLAG = 0
        WHERE t.CMDSTYPE = 1
        AND comp_sub.cinner =0
        AND comp_sub.cdel_flag =0
        <![CDATA[
        AND comp_sub.cstatus <> 'ED'
        ]]>
        ORDER BY comp_parent.CCREATE_DATE ASC
    </select>

    <select id="countComponents" resultType="long">
        SELECT COUNT(DISTINCT pstr.CCKID)
        FROM t_mds t
        JOIN t_structure_list pstr ON pstr.CCKID = t.CKID
        JOIN T_COMPONENT_NODE comp_parent ON pstr.CCKID = comp_parent.CKID
        WHERE t.CMDSTYPE = 1
        <if test="parentNameLike != null and parentNameLike != ''">
            AND comp_parent.CNAME LIKE CONCAT('%', #{parentNameLike}, '%')
        </if>
    </select>

    <insert id="batchInsertAnnotatedData">
        INSERT INTO t_annotated_components (
            parent_struct_id, parent_ckid, parent_name, parent_symbol, parent_weight,
            subnode_type, subnode_ckid, subnode_name, subnode_symbol, subnode_weight,
            subnode_struct_id, manual_label, create_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.parentStructId}, #{item.parentCkid}, #{item.parentName}, 
                #{item.parentSymbol}, #{item.parentWeight}, #{item.subnodeType},
                #{item.subnodeCkid}, #{item.subnodeName}, #{item.subnodeSymbol},
                #{item.subnodeWeight}, #{item.subnodeStructId}, #{item.manualLabel},
                SYSDATE
            )
        </foreach>
    </insert>
</mapper>
    